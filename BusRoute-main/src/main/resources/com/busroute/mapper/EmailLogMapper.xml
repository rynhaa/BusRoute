<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.busroute.mapper.EmailLogMapper">

    <insert id="insertEmailLog" parameterType="com.busroute.domain.EmailLogVO">
        INSERT INTO tb_email_log (
            recipient_email, subject, content_preview, send_status, fail_reason, sent_by
        ) VALUES (
            #{recipient_email}, #{subject}, #{content_preview}, #{send_status}, #{fail_reason}, #{sent_by}
        )
    </insert>

    <select id="findAll" resultType="com.busroute.domain.EmailLogVO">
        SELECT * FROM tb_email_log ORDER BY sent_at DESC
    </select>

	<select id="getTotalCount" resultType="int">
	    SELECT COUNT(*)
	    FROM tb_email_log
	    WHERE 
	        (<if test="keyword != null and keyword != ''">
	            recipient_email LIKE CONCAT('%', #{keyword}, '%') OR subject LIKE CONCAT('%', #{keyword}, '%')
	        </if>
	        <if test="keyword == null or keyword == ''">
	            1 = 1
	        </if>)
	        <if test="send_status != null and send_status != ''">
	            AND send_status = #{send_status}
	        </if>
	</select>

	<select id="findWithPagingAndFilter" resultType="com.busroute.domain.EmailLogVO">
	    SELECT *
	    FROM tb_email_log
	    WHERE 
	        <if test="keyword != null and keyword != ''">
	            (recipient_email LIKE CONCAT('%', #{keyword}, '%') OR subject LIKE CONCAT('%', #{keyword}, '%'))
	        </if>
	        <if test="keyword == null or keyword == ''">
	            1 = 1
	        </if>
	        <if test="send_status != null and send_status != ''">
	            AND send_status = #{send_status}
	        </if>
	    ORDER BY sent_at DESC
	    LIMIT #{limit} OFFSET #{offset}
	</select>

</mapper>
